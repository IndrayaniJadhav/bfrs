{% extends "admin/base_site.html" %}
{% load static from staticfiles %}
{% load bfrs_tags %}

{% block content %}

<div>
    <div style="float: left;">
        <h1>Bushfire Overview</h1>
    </div>
    <br>

</div>

{% comment %}
<form id="bushfire_create" name="bushfire_create" action="{% url 'bushfire:bushfire_create' %}" method="post" target="_blank">
    <input type="hidden" name="sss_create" id="sss_create">
</form>
<button id="my-btn2" type="button">My Test 2</button>
{% endcomment %}

<br>
<br>

<div class="dropdown btn btn-medium" style="float: right">
  <button id="dropdown_btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <a href="#">Reports</a>
    <span class="caret"></span>
  </button>

  <ul class="dropdown-menu" aria-labelledby="dropdown_btn">
    <li><a href="javascript: bushfire_filter('export_to_excel=True');">Export Excel</a></li>
{% comment %}
    <li><a href="javascript: bushfire_filter('export_to_csv=True');">Export CSV</a></li>
{% endcomment %}
  </ul>
</div>

{% include "bfrs/bushfire_filter.html" %}

{% comment %}
<form id="bushfire_create" name="bushfire_create" action="{% url 'bushfire:bushfire_create' %}" method="post" target="_blank">
<div>

    <span>Action</span>
    <select id="actions">
    <option value="0" selected="selected">----</option>
    <option value="1">Archive Report</option>
    </select>
    <button id="action-btn" name="action" class="btn btn-small btn-info" type="button" disabled>Go</button>
</div>
</form>
{% endcomment %}

{% if object_list %}
<table id="table" class="tablesorter table table-striped table-bordered table-hover table-condensed" style="cursor:pointer;">
  <thead>
	  {%comment%}<td><input type="checkbox" name ="check_all" onClick=toggle(this) /></td>{%endcomment%}
	  <th><font color="dodgerblue">Fire Number <i class="icon-sort"></i></font></th>
	  <th><font color="dodgerblue">Name <i class="icon-sort"></i></font></th>
	  <th><font color="dodgerblue">Initial <i class="icon-sort"></font></i></th>
	  <th><font color="dodgerblue">Final <i class="icon-sort"></i></font></th>
	  {% if can_maintain_data %}<th><font color="dodgerblue">Review <i class="icon-sort"></i></font></th>{% endif %}
	  <th><font color="dodgerblue"><i class="icon-sort"></i></font></th>

  </thead>
  <tbody>
    {% for bushfire in object_list %}
      <tr class="row-vm" data-toggle="myCollapse" data-target="#{{bushfire.id}}">
		  {%comment%}<td><input type="checkbox" name="chkbox" value={{ bushfire.id }}  /></td>{%endcomment%}
        <td>{{ bushfire.fire_number }}</td>
        <td>{{ bushfire.name }}</td>
		<td align="center">
            {% if bushfire.report_status == bushfire.STATUS_INITIAL %}
			<a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="Edit initial fire report"><font color="red"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-edit icon-white"></i></font></a>
            {% elif bushfire.report_status == bushfire.STATUS_INVALIDATED %}
			<a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="View the invalidated initial fire report"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-ban-circle icon-white"></i></a>
		    {% else %}
			<a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="Initial fire report submitted on {{bushfire.init_authorised_date|date_fmt}} by {{bushfire.init_authorised_by}}"><span style="display:none">{{bushfire.report_status}}</span><font color="green"><i class="icon-ok icon-white"></i></font></a>
		    {% endif %}
		</td>

		<td align="center">
            {% if bushfire.report_status == bushfire.STATUS_INITIAL_AUTHORISED %}
			<a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Edit final fire report"><span style="display:none">{{bushfire.report_status}}</span><font color="red"><i class="icon-edit icon-white"></i></red></a>
            {% elif bushfire.report_status >= bushfire.STATUS_FINAL_AUTHORISED and bushfire.report_status != bushfire.STATUS_INVALIDATED%}
			<a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Final fire report authorised on {{bushfire.authorised_date}} by {{bushfire.authorised_by}}"><span style="display:none">{{bushfire.report_status}}</span><font color="green"><i class="icon-ok icon-white"></i></font></a>
		    {% endif %}
		</td>

        {% if can_maintain_data %}
        <td align="center">
          {% if bushfire.report_status == bushfire.STATUS_FINAL_AUTHORISED %}
		  <a href="#" onclick='openGokart({"region":{{bushfire.region.id}},"district":{{bushfire.district.id}},"bushfireid":"{{bushfire.fire_number}}" });' title="Open report in SSS"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-link icon-white"></i></a>
          {% elif bushfire.report_status == bushfire.STATUS_REVIEWED %}
		  <a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Final fire report reviewed on {{bushfire.reviewed_date}} by {{bushfire.reviewed_by}}"><span style="display:none">{{bushfire.report_status}}</span><font color="green"><i class="icon-ok icon-white"></i></font></a>
          {% endif %}
		</td>
        {% endif %}

         {% if bushfire.report_status == bushfire.STATUS_FINAL_AUTHORISED %}
           {% if can_maintain_data %}
           <td>
			 <a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=mark_reviewed');" title="Mark Final report as Reviewed"><span style="display:none">{{bushfire.report_status}}</span><font color="red"><i class="icon-warning-sign"></i></font></a>
			 <a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=delete_final_authorisation');" title="Delete authorisation"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-trash icon-white"></i></a>
		   </td>
           {% endif %}

         {% elif bushfire.report_status == bushfire.STATUS_REVIEWED %}
           {% if not bushfire.archive %}
             <td>
				 <a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=archive');" title="Archive Report"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-folder-close"></i></a>
				 {% if can_maintain_data %}<a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=delete_reviewed');" title="Delete reviewed"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-trash icon-white"></i></a>{% endif %}
			 </td>
           {% else %}
		     <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=unarchive');" title="Unarchive Report"><span style="display:none">{{bushfire.report_status}}</span><i class="icon-folder-open"></i></a></td>
           {% endif %}
         {% else %}
	     <td></td>
         {% endif %}

      </tr>

      <tr class="myCollapse row-details expand-child" id="{{bushfire.id}}">
        <td colspan="9">
          <table class="table table-bordered table-striped table-condensed">
            <tbody>
              <tr>
                <th>Region</th>
                <td>{{ bushfire.region.name }}</td>
                <th colspan="1">District</th>
                <td>{{ bushfire.district.name }}</td>
              </tr>
              <tr>
                <th colspan="1">Field Officer</th>
                <td>{{ bushfire.field_officer }}</td>
                <th colspan="1">Duty Officer</th>
                <td>{{ bushfire.duty_officer }}</td>
              </tr>
              <tr>
                <th colspan="1">No. of Archived Snapshots</th>
		        <td colspan="3"><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&action=snapshot_history');" title="Snapshot history details">{{ bushfire.snapshot_history.count }}</a></td>
              </tr>
			  <tr>
                <th>Linked bushfires</th>
				<td colspan="3" >
                  {% if bushfire.invalidated.all or bushfire.valid_bushfire %}
                  <table class="table table-bordered table-condensed">
			        <thead>
                      <th>Fire Number</th>
                      <th>Date</th>
                      <th>User</th>
                      <th>Status</th>
                      <th>Details</th>
                    </thead>
                    <tbody>
                    {% if bushfire.invalidated.all %}
                      {% for linked_obj in bushfire.invalidated.all %}
                      <tr>
				        <td><a href="{% url 'bushfire:bushfire_initial' linked_obj.id %}">{{linked_obj.fire_number}}</a></td>
				        <td>{{linked_obj.modified|date_fmt}}</td>
				        <td>{{linked_obj.modifier}}</td>
				        <td>{{linked_obj.get_report_status_display}}</td>
				        <td>{{linked_obj.invalid_details}}</td>
                      </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
				        <td><a href="{% url 'bushfire:bushfire_initial' bushfire.valid_bushfire.id %}">{{bushfire.valid_bushfire.fire_number}}</a></td>
				        <td>{{bushfire.valid_bushfire.modified|date_fmt}}</td>
				        <td>{{bushfire.valid_bushfire.modifier}}</td>
				        <td>{{bushfire.valid_bushfire.get_report_status_display}}</td>
				        <td>{{bushfire.valid_bushfire.invalid_details}}</td>
                      </tr>
                    {% endif %}

                    </tbody>
                  </table>
                  {% else %}
				    No linked records
                  {% endif %}
				</td>
              </tr>

            </tbody>
          </table>
        </td>
      </tr>

    {% endfor %}
  </tbody>
</table>

{% else %}
    <p>No Bushfires are available.</p>
{% endif %}

<script src="{{sss_url}}/dist/static/js/gokart.js"></script>
<script>

    $("#table").tablesorter();

    $("[data-toggle=myCollapse]").click(function( ev ) {
      ev.preventDefault();
      var target;
      if (this.hasAttribute('data-target')) {
    target = $(this.getAttribute('data-target'));
      } else {
    target = $(this.getAttribute('href'));
      };
      target.toggleClass("in");
    });

    $("#table td a").on('click', function (e) { e.stopPropagation(); })

/* Filter Args Section - This appends the required filter args to the GET URL */
$(function(){

    bushfire_filter = function(params) {
        /*
        Function to append filter fields to the URL, only those that are selected. Default <form action="#"> adds all fields to the url, even if empty
        */

        profile_field_list = ['region', 'district'];
        filter_list = [
			'region', 'district', 'year', 'reporting_year', 'report_status', 
		];

        var count = 0;
        var url = "{% url 'main' %}";
        for (var i = 0; i < filter_list.length; i++) {
          var field_value = $("#id_" + filter_list[i]).val();
          if (field_value) {
            //alert("VAL: " + field_value);
            var postfix = (count==0 ? "?" : "&");
            url += postfix + filter_list[i] + "=" + $("#id_" + filter_list[i]).val();
            count++;
		  /* Check if string filter_list[i] exists in profile_field_list. This will add the field without a value, allowing Bushfire View to deal an 'All' selection (to distinguish from profile) */
		  } else if (new RegExp(profile_field_list.join('|')).test(filter_list[i])) {
            var postfix = (count==0 ? "?" : "&");
            url += postfix + filter_list[i] + "=";
            count++;
		  }
        }

		if($('#id_include_archived').is(':checked')) {
            var postfix = (count==0 ? "?" : "&");
			url += postfix + 'include_archived=True'
		}

		/* Append the additional parameters such as "export_to_csv=final&stuff=ABC" */
		if (params) {
            var postfix = (count==0 ? "?" : "&");
			url += postfix + params
		}
        //alert("URL: " + url);

        location.href = url
    };

});
/* END Filter Args Section */

/* GoKart section */
    gokart = Gokart.get('bfrs','{{sss_url}}');

    function openGokart(open_options) {
        gokart.call("open", open_options);
    }

//    if ({{request.session.refreshGokart|yesno:"true,false"}}) {
//        //console.log("region " + {{request.session.region}} + " - district " + {{request.session.district}});
//        gokart.call("open", {"region":{{request.session.region}}, "district":{{request.session.district}}, "refresh":true});
//    }
/* END - GoKart section */


/* SSS Test Section - Use to test SSS functionality */
    var spatial_data = {
		'area': 3505.852444397427,
		'fire_boundary': [[[[115.74110902213813, -30.92680264785486],
			[115.75209530829225, -30.92577268352791],
			[115.7424823079074, -30.906546682758183],
			[115.71947977127219, -30.913069790162197],
			[115.74110902213813, -30.92680264785486]]],
		[[[115.76376823733102, -30.93847557689362],
			[115.79569713146645, -30.954611684682497],
			[115.80325020319742, -30.93950554122057],
			[115.82865598992885, -30.93950554122057],
			[115.83037259714042, -30.92748929073949],
			[115.8506285622371, -30.92748929073949],
			[115.85234516944868, -30.898650289584904],
			[115.78917402406245, -30.901740182565753],
			[115.76376823733102, -30.93847557689362]]]],
		'origin_point': [115.7757844878121, -30.93847557689362],
		'tenure_area': [
			{
				'area': 191.62466910416006,
				'category': 'Nature Reserve',
				'id': 4092,
				'name': 'Bundarra Nature Reserve'
			},
			{
				'area': 591.2277122903795,
				'category': 'Crown Freehold - Dept Interest',
				'id': 5834,
				'name': '2745/507'
			},
			{
				'area': 390.20206931627854,
				'category': 'Crown Freehold - Dept Interest',
				'id': 8193,
				'name': '2803/443'
			},
			{
				'area': 228.67239551333384,
				'category': 'Crown Freehold - Dept Interest',
				'id': 8289,
				'name': '2802/584'
			},
			{
				'area': 2104.125598173275, 
				'category': null, 
				'id': null, 
				'name': null
			},
			{
				'area': 895.8744018267248, 
				'category': null, 
				'id': null, 
				'name': null
			}

		],
		'tenure_ignition_point': {
			'category': 'Crown Freehold - Dept Interest',
			'id': 8193,
			'name': '2803/443'
		},
		'fire_position':'38.85km NWbN from KOOLYANOBBING'
	}

    $('#my-btn2').click(function() {
		console.log('spatial_data' + spatial_data)
        $("#sss_create").val(JSON.stringify(spatial_data));
        $("#bushfire_create").submit();
    });
/* END - SSS Test Section */



</script>
{% endblock %}
