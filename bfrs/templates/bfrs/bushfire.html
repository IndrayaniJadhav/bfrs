{% extends "admin/base_site.html" %}
{% load static from staticfiles %}
{% load bfrs_tags %}

{% block content %}

<div>
    <div style="float: left;">
        <h1>Bushfire Overview</h1>
    </div>
    <br>

{% comment %}
    <div style="float: right;">
      {% if request.user|can_readonly and not request.user.is_superuser %}
        <a href="{% url 'bushfire:bushfire_create' %}"><button disabled style="color:Grey;" title="You do not have 'Create' permissions"><i class="icon-plus icon-white"></i> Add Bushfire</button></a>
      {% else %}
        <a href="{% url 'bushfire:bushfire_create' %}"><button><i class="icon-plus icon-white"></i> Add Bushfire</button></a>
      {% endif %}
    </div>
{% endcomment %}
</div>

{% comment %}
<button id="my-btn" type="button">My Test</button>
{% endcomment %}

{% comment %}
<form id="bushfire_create" name="bushfire_create" action="{% url 'bushfire:bushfire_create' %}" method="post" target="_blank">
    <input type="hidden" name="sss_create" id="sss_create">
</form>
<button id="my-btn2" type="button">My Test 2</button>
{% endcomment %}

<br>
{% comment %}
<p>perms: {{perms}}</p>
<p>perms.app_label: {{perms.app_label}}</p>
<p>perms.bfrs.view_bushfire: {{perms.bfrs.view_bushfire}}</p>
<p>user: {{user}}</p>
<p>user.groups 1: {{user.groups.all}}</p>
<p>user.groups 2: {% if request.user|can_readonly %} True jm 2 {% endif %}</p>
{% endcomment %}

<br>

<div class="dropdown btn btn-medium" style="float: right">
  <button id="dropdown_btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <a href="#">Reports</a>
    <span class="caret"></span>
  </button>

  <ul class="dropdown-menu" aria-labelledby="dropdown_btn">
    <li><a href="javascript: bushfire_filter('export_to_excel=True');">Export Excel</a></li>
    <li><a href="javascript: bushfire_filter('export_to_csv=True');">Export CSV</a></li>
  </ul>
</div>

{% include "bfrs/bushfire_filter.html" %}

{% comment %}
<form id="bushfire_create" name="bushfire_create" action="{% url 'bushfire:bushfire_create' %}" method="post" target="_blank">
<div>

    <span>Action</span>
    <select id="actions">
    <option value="0" selected="selected">----</option>
    <option value="1">Archive Report</option>
    </select>
    <button id="action-btn" name="action" class="btn btn-small btn-info" type="button" disabled>Go</button>
</div>
</form>
{% endcomment %}

<input type="hidden" id="gokart_url" value="{{sss_url}}" name="gokart_url" type="text">
<input type="hidden" id="gokart_module" value="bfrs" name="gokart_module" type="text">
{% comment %}
<!-- http://static.dpaw.wa.gov.au/pages/test-gokartclient.html?debug=true -->
<input type="hidden" id="gokart_module" value="bfrs" name="gokart_module" type="text">
<input type="hidden" id="open_options" value='{"region":7,"district":13,"bushfireid":5}' name="gokart_url" type="text">
<input onclick="gokart = loadGokart(); openGokart()" name="button" value="Open" type="button">
{% endcomment %}

{% if object_list %}
<table id="table" class="tablesorter table table-striped table-bordered table-hover table-condensed">
  <thead>
    <td><input type="checkbox" name ="check_all" onClick=toggle(this) /></td>
    <th>Fire Number</th>
    {% comment %}<th>Report Status</th> {% endcomment %}
    <th>Name</th>
    <th>Initial</th>
    <th>Final</th>
    <th>Review</th>

  </thead>
  <tbody>
    {% for bushfire in object_list %}
      <tr class="row-vm" data-toggle="myCollapse" data-target="#{{bushfire.id}}">
        <td><input type="checkbox" name="chkbox" value={{ bushfire.id }}  /></td>
        <td>{{ bushfire.fire_number }}</td>
        {% comment %}<td>{{ bushfire.get_report_status_display }}</td> {% endcomment %}
        <td>{{ bushfire.name }}</td>
		<td align="center">
            {% if bushfire.report_status == bushfire.STATUS_INITIAL %}
              <a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="Edit initial fire report"><i class="icon-edit icon-white"></i></a>
            {% elif bushfire.report_status == bushfire.STATUS_INVALIDATED %}
              <a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="View the invalidated initial fire report"><i class="icon-ban-circle icon-white"></i></a>
		    {% else %}
			  <a href="{% url 'bushfire:bushfire_initial' bushfire.id %}" title="Initial fire report submitted on {{bushfire.init_authorised_date|date_fmt}} by {{bushfire.init_authorised_by}}"><i class="icon-ok icon-white"></i></a>
		    {% endif %}
		</td>

		<td align="center">
            {% if bushfire.report_status == bushfire.STATUS_INITIAL_AUTHORISED %}
		      <a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=create_final');" title="Create final fire report"><i class="icon-plus icon-white"></i></a>
            {% elif bushfire.report_status == bushfire.STATUS_FINAL_DRAFT %}
              <a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Edit final fire report"><i class="icon-edit icon-white"></i></a>
            {% elif bushfire.report_status >= bushfire.STATUS_FINAL_AUTHORISED and bushfire.report_status != bushfire.STATUS_INVALIDATED%}
              <a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Final fire report authorised on {{bushfire.authorised_date}} by {{bushfire.authorised_by}}"><i class="icon-ok icon-white"></i></a>
		    {% endif %}
		</td>
        <td align="center">
         {% if bushfire.report_status == bushfire.STATUS_FINAL_AUTHORISED %}
            <a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=create_review');" title="Create review report"><i class="icon-plus icon-white"></i></a>
         {% elif bushfire.report_status == bushfire.STATUS_REVIEW_DRAFT %}
            <input type="hidden" id="open_options" value='{"region":{{bushfire.region.id}},"district":{{bushfire.district.id}},"bushfireid":{{bushfire.id}}}' name="gokart_url" type="text">
            <a href="#" onclick="gokart = loadGokart(); openGokart()" title="Open report in SSS"><i class="icon-link icon-white"></i></a>

            {% comment %}
            <a href="{% url 'sss_home' %}" title="Open report in SSS" target="_blank"><i class="icon-link icon-white"></i></a>
            <a href="#" id="id_open_sss" title="Open report in SSS 3"><i class="icon-link icon-white"></i></a>
            <input onclick="gokart = loadGokart(); openGokart()" name="button" value="Open" type="button">
            {% endcomment %}

         {% elif bushfire.report_status == bushfire.STATUS_REVIEWED %}
            <a href="{% url 'bushfire:bushfire_final' bushfire.id %}" title="Final fire report reviewed on {{bushfire.reviewed_date}} by {{bushfire.reviewed_by}}"><i class="icon-ok icon-white"></i></a>

         {% endif %}
		</td>


         {% if bushfire.report_status == bushfire.STATUS_INITIAL %}
         <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=submit_initial');" title="submit initial"><font color="red"><i class="icon-warning-sign"></i></font></a></td>

         {% elif bushfire.report_status == bushfire.STATUS_FINAL_DRAFT %}
         <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=authorise_final');" title="Authorise final report"><font color="red"><i class="icon-warning-sign"></i></font></a></td>
         {% elif bushfire.report_status == bushfire.STATUS_FINAL_AUTHORISED %}
         <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=delete_final_authorisation');" title="Delete authorisation"><i class="icon-trash icon-white"></i></a></td>
         {% elif bushfire.report_status == bushfire.STATUS_REVIEW_DRAFT %}
         <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=mark_reviewed');" title="Mark Final report as Reviewed"><font color="red"><i class="icon-warning-sign"></i></font></a></td>
         {% elif bushfire.report_status == bushfire.STATUS_REVIEWED %}
           {% if not bushfire.archive %}
             <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=archive');" title="Archive Report"><i class="icon-folder-close"></i></a></td>
           {% else %}
             <td><a href="javascript: bushfire_filter('bushfire_id={{bushfire.id}}&confirm_action=unarchive');" title="Unarchive Report"><i class="icon-folder-open"></i></a></td>
           {% endif %}
         {% endif %}

        {% comment %}
            <td>{% if init_authorised %} <a href="{% url 'bushfire:bushfire_final' bushfire.id %}">{{ bushfire.name }} {% else %} {{bushfire.name}} {% endif %}</td>
        <td><a href="{% url 'bushfire:bushfire' bushfire.id %}">{{ bushfire.name }}</td>
        {% endcomment %}
      </tr>

      <tr class="myCollapse row-details expand-child" id="{{bushfire.id}}">
        <td colspan="9">
          <table class="table table-bordered table-striped table-condensed">
            <tbody>
              <tr>
                <th>Region</th>
                <td>{{ bushfire.region.name }}</td>
                <th colspan="1">District</th>
                <td>{{ bushfire.district.name }}</td>
              </tr>
              <tr>
                <th colspan="1">Field Officer</th>
                <td>{{ bushfire.field_officer }}</td>
                <th colspan="1">Duty Officer</th>
                <td>{{ bushfire.duty_officer }}</td>
              </tr>
			  <tr>
                <th>Linked bushfires</th>
				<td colspan="3" >
                  {% if bushfire.linked.all %}
                  <table class="table table-bordered table-condensed">
			        <thead>
                      <th>Fire Number</th>
                      <th>Date</th>
                      <th>User</th>
                      <th>Invalid</th>
                      <th>Details</th>
                    </thead>
                    <tbody>
                    {% for linked_obj in bushfire.linked.all %}
                      <tr>
				        <td><a href="{% url 'bushfire:bushfire_initial' linked_obj.linked_bushfire.id %}">{{linked_obj.linked_bushfire.fire_number}}</a></td>
				        <td>{{linked_obj.modified|date_fmt}}</td>
				        <td>{{linked_obj.modifier}}</td>
				        <td>{{linked_obj.linked_bushfire.report_status|yesno:"Yes,No"}}</td>
				        <td>{{linked_obj.linked_bushfire.invalid_details}}</td>
                      </tr>
                    {% endfor %}
                    </tbody>
                  </table>
                  {% else %}
				    No linked records
                  {% endif %}
				</td>
              </tr>

            </tbody>
          </table>
        </td>
      </tr>

    {% endfor %}
  </tbody>
</table>

{% else %}
    <p>No Bushfires are available.</p>
{% endif %}

<script>

$("#id_open_sss").on('click', function() {
   gokart = loadGokart(); openGokart();
});

    //var spatial_data = {"area":5068734.39165385, "origin_point":[117.30008118682615,-30.849007786590157]};
    var spatial_data = {
		'area': 3505.852444397427,
		'fire_boundary': [[[[115.74110902213813, -30.92680264785486],
			[115.75209530829225, -30.92577268352791],
			[115.7424823079074, -30.906546682758183],
			[115.71947977127219, -30.913069790162197],
			[115.74110902213813, -30.92680264785486]]],
		[[[115.76376823733102, -30.93847557689362],
			[115.79569713146645, -30.954611684682497],
			[115.80325020319742, -30.93950554122057],
			[115.82865598992885, -30.93950554122057],
			[115.83037259714042, -30.92748929073949],
			[115.8506285622371, -30.92748929073949],
			[115.85234516944868, -30.898650289584904],
			[115.78917402406245, -30.901740182565753],
			[115.76376823733102, -30.93847557689362]]]],
		'origin_point': [115.7757844878121, -30.93847557689362],
		'tenure_area': [
			{
				'area': 191.62466910416006,
				'category': 'Nature Reserve',
				'id': 4092,
				'name': 'Bundarra Nature Reserve'
			},
			{
				'area': 591.2277122903795,
				'category': 'Crown Freehold - Dept Interest',
				'id': 5834,
				'name': '2745/507'
			},
			{
				'area': 390.20206931627854,
				'category': 'Crown Freehold - Dept Interest',
				'id': 8193,
				'name': '2803/443'
			},
			{
				'area': 228.67239551333384,
				'category': 'Crown Freehold - Dept Interest',
				'id': 8289,
				'name': '2802/584'
			},
			{
				'area': 2104.125598173275, 
				'category': null, 
				'id': null, 
				'name': null
			},
			{
				'area': 895.8744018267248, 
				'category': null, 
				'id': null, 
				'name': null
			}

		],
		'tenure_ignition_point': {
			'category': 'Crown Freehold - Dept Interest',
			'id': 8193,
			'name': '2803/443'
		},
		'fire_position':'38.85km NWbN from KOOLYANOBBING'
	}

    $('#my-btn').click(function() {
        $.ajax({
            type:"POST",
            url:"{% url 'bushfire:bushfire_create' %}",
            data: {"sss_create": JSON.stringify(spatial_data)},
        });
    });

    $('#my-btn2').click(function() {
		console.log('spatial_data' + spatial_data)
        $("#sss_create").val(JSON.stringify(spatial_data));
        $("#bushfire_create").submit();
    });

    $("[data-toggle=myCollapse]").click(function( ev ) {
      ev.preventDefault();
      var target;
      if (this.hasAttribute('data-target')) {
    target = $(this.getAttribute('data-target'));
      } else {
    target = $(this.getAttribute('href'));
      };
      target.toggleClass("in");
    });

    $("#table td a").on('click', function (e) { e.stopPropagation(); })

$(function(){

    bushfire_filter = function(params) {
        /*
        Function to append filter fields to the URL, only those that are selected. Default <form action="#"> adds all fields to the url, even if empty
        */

        profile_field_list = ['region', 'district'];
        filter_list = [
			'region', 'district', 'year', 'reporting_year', 'report_status', 
		];

        var count = 0;
        var url = "{% url 'main' %}";
        for (var i = 0; i < filter_list.length; i++) {
          var field_value = $("#id_" + filter_list[i]).val();
          if (field_value) {
            //alert("VAL: " + field_value);
            var postfix = (count==0 ? "?" : "&");
            url += postfix + filter_list[i] + "=" + $("#id_" + filter_list[i]).val();
            count++;
		  /* Check if string filter_list[i] exists in profile_field_list. This will add the field without a value, allowing Bushfire View to deal an 'All' selection (to distinguish from profile) */
		  } else if (new RegExp(profile_field_list.join('|')).test(filter_list[i])) {
            var postfix = (count==0 ? "?" : "&");
            url += postfix + filter_list[i] + "=";
            count++;
		  }
        }

		if($('#id_include_archived').is(':checked')) {
            var postfix = (count==0 ? "?" : "&");
			url += postfix + 'include_archived=True'
		}

		/* Append the additional parameters such as "export_to_csv=final&stuff=ABC" */
		if (params) {
            var postfix = (count==0 ? "?" : "&");
			url += postfix + params
		}
        //alert("URL: " + url);

        location.href = url
    };

});


/*
    $("#id_region").click(function() {
        $.ajax({
            type:"GET",
            url:"{% url 'bushfire:bushfire_create' %}",
            data: {
                "region": $("#id_region").val(),
                "csrfmiddlewaretoken": "{{ csrf_token }}",
            },
            success: function(response){
                var response = JSON.parse(response);
                console.log("response " + response);
            }

        });
    });
*/


/* GoKart section */
    var gokartScript = null
    var gokart = null

    function loadGokart() {
        var url = document.getElementById('gokart_url').value || "https://sss.dpaw.wa.gov.au";
        var module = document.getElementById('gokart_module').value || "bfrs"
        var app = "sss"

        var scriptUrl = url + "/dist/static/js/gokart.js";
        if (gokartScript && true) {//gokartScript.src !== scriptUrl) {
            console.log("gokart script is removed");
            if (gokart) gokart.close()
            gokartScript.parentNode.removeChild(gokartScript);
            gokartScript = null;
        }
        if (!gokartScript) {
            console.log("gokart script is added to the document");
            gokartScript = document.createElement("script");
            gokartScript.setAttribute('type','text/javascript');
            gokartScript.setAttribute('src',scriptUrl)
            gokartScript.onload = function() {
                console.log("gokart script is loaded");
                gokart = Gokart.get(module,url,app);
            }
            document.body.appendChild(gokartScript);
        } else {
            gokart = Gokart.get(module,url,app);
        }
    }

    function openGokart() {
        var func = function() {
            if (gokart) {
                console.log('open_options: ' + document.getElementById('open_options').value)
                gokart.open(JSON.parse(document.getElementById('open_options').value));
            } else {
                setTimeout(func,500)
            }
        }
        func()
    }
/* END - GoKart section */


</script>
{% endblock %}
